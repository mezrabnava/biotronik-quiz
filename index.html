import React, { useState, useEffect } from 'react';
import { Brain, Trophy, ChevronRight, RotateCcw, Mail } from 'lucide-react';

const MedTechQuiz = () => {
  const [screen, setScreen] = useState('attract');
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showFeedback, setShowFeedback] = useState(false);
  const [allScores, setAllScores] = useState([]);
  const [email, setEmail] = useState('');
  const [inactivityTimer, setInactivityTimer] = useState(null);

  const questions = [
    {
      question: "CLS has been studied in how many patients worldwide?",
      answers: ["<1000", "2000", "4000", ">6000"],
      correct: 3
    },
    {
      question: "Between 2021 and 2025, which company had the highest number of CRM device recalls?",
      answers: ["MDT", "BIO", "ABT", "BSX"],
      correct: 0
    },
    {
      question: "What percentage of BIOTRONIK employees at Berlin HQ are dedicated to quality assurance?",
      answers: ["5%", "8%", "12%", ">15%"],
      correct: 3
    },
    {
      question: "Which BIOTRONIK ICD system provides dual-chamber AF detection without an atrial lead?",
      answers: ["CLS", "DX ICD System", "BIOMONITOR", "Selectra 3D"],
      correct: 1
    },
    {
      question: "What was the cost to Medicare for the 7 major cardiac device recalls between 2005-2014?",
      answers: ["$500 million", "$750 million", "$1 billion", "$1.5 billion"],
      correct: 2
    },
    {
      question: "Which exclusive BIOTRONIK algorithm puts the autonomic nervous system back in control of heart rate?",
      answers: ["Minute Ventilation", "QT Sensor", "Closed Loop Stimulation (CLS)", "Adaptive Pacing Mode"],
      correct: 2
    },
    {
      question: "Which CRM company currently has no open recalls?",
      answers: ["MDT", "BSX", "BIO", "ABT"],
      correct: 2
    },
    {
      question: "Where are BIOTRONIK's device batteries manufactured?",
      answers: ["USA", "Germany", "Malaysia", "Puerto Rico"],
      correct: 1
    },
    {
      question: "In a large, long-term study (Mitacchione et al 54 month follow-up), what percentage of DX ICD patients did not require an atrial lead upgrade?",
      answers: ["50%", "75.4%", "85.9%", "98.7%"],
      correct: 3
    },
    {
      question: "Implanting an atrial lead in ICD patients without pacing needs increases the odds of complications by what percentage?",
      answers: ["10%", "25%", "40%", "60%"],
      correct: 2
    },
    {
      question: "What does CLS directly measure to adapt heart rate physiologically?",
      answers: ["Body temperature", "Myocardial contractility", "Patient steps", "Oxygen saturation"],
      correct: 1
    },
    {
      question: "Beyond movement (physical exercise) what can CLS uniquely respond to?",
      answers: ["Environmental temperature", "Acute mental stress", "High altitude", "Sleep apnea"],
      correct: 1
    },
    {
      question: "CLS is included in which BIOTRONIK therapy categories?",
      answers: ["Pacemakers only", "ICDs only", "Pacemakers and CRT-P", "All pacemakers, ICDs, and CRT devices"],
      correct: 3
    },
    {
      question: "In clinical studies, CLS has been proven to:",
      answers: ["Reduce risk of subclinical AF", "Restore physiologic heart rates", "Help to improve quality of life and symptoms of OH", "All of the above"],
      correct: 3
    },
    {
      question: "BIOTRONIK's Home Monitoring technology allows for what type of patient monitoring?",
      answers: ["Weekly check-ins", "Monthly reports", "Automatic daily transmission", "On-demand only"],
      correct: 2
    },
    {
      question: "What year was BIOTRONIK founded?",
      answers: ["1953", "1963", "1973", "1983"],
      correct: 1
    },
    {
      question: "Which BIOTRONIK innovation was the world's first MRI-conditional fully automated device?",
      answers: ["SuperMRI in the Super Mario family", "MRI Guard 24/7 in the Amvia pacemaker family", "AutoMRI in all device families", "MRIsure in Les Misérables family"],
      correct: 1
    },
    {
      question: "What is a key advantage of BIOTRONIK's DX ICD technology?",
      answers: ["Smaller device size", "Eliminates need for atrial lead in many patients", "Wireless charging capability", "Smartphone connectivity"],
      correct: 1
    },
    {
      question: "What makes BIOTRONIK's CRT-DX system unique?",
      answers: ["Requires 3 atrial leads", "Provides CRT dual-chamber pacing and atrial sensing with only 2 leads", "Has no atrial sensing capability", "Is only available in Europe"],
      correct: 1
    },
    {
      question: "What key benefit does CRT-DX provide compared to conventional CRT systems?",
      answers: ["Fewer major complications", "Reduced procedure time", "Equivalent CRT response to traditional 3-lead CRT-D", "All of the above"],
      correct: 3
    },
    {
      question: "What is the average post-stroke care cost per patient, in the United States (excluding rehab)?",
      answers: ["Less than $50,000", "$75,000", "$100,000", "$125,000", "$140,000", "more than $150,000"],
      correct: 4
    },
    {
      question: "Margolis et al 2023 reported that the addition of an atrial lead in ICDs was an independent predictor for any complication, namely pneumothorax/hemothorax and atrial lead dislodgement. What was the net increase in the complications rate for the dual-chamber ICD cohort, compared to the single-chamber cohort?",
      answers: ["1%", "1.5%", "1.8%", "2.1%"],
      correct: 3
    },
    {
      question: "What fraction of CRT-D patients do not require atrial pacing?",
      answers: ["100%", "50%", "20%", "0%"],
      correct: 2
    }
  ];

  // Reset to attract screen after 30 seconds of inactivity
  useEffect(() => {
    const resetTimer = () => {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (screen !== 'attract') {
        const timer = setTimeout(() => {
          setScreen('attract');
          setCurrentQuestion(0);
          setScore(0);
          setSelectedAnswer(null);
          setShowFeedback(false);
          setEmail('');
        }, 30000);
        setInactivityTimer(timer);
      }
    };

    resetTimer();
    return () => {
      if (inactivityTimer) clearTimeout(inactivityTimer);
    };
  }, [screen, currentQuestion, selectedAnswer]);

  const startQuiz = () => {
    setScreen('quiz');
    setCurrentQuestion(0);
    setScore(0);
    setSelectedAnswer(null);
    setShowFeedback(false);
  };

  const handleAnswer = (index) => {
    if (showFeedback) return;
    
    setSelectedAnswer(index);
    setShowFeedback(true);
    
    if (index === questions[currentQuestion].correct) {
      setScore(score + 1);
    }
  };

  const nextQuestion = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer(null);
      setShowFeedback(false);
    } else {
      const newScore = {
        score: score + (selectedAnswer === questions[currentQuestion].correct ? 1 : 0),
        total: questions.length,
        timestamp: new Date().toLocaleString(),
        email: email || 'Anonymous'
      };
      setAllScores([...allScores, newScore]);
      setScreen('results');
    }
  };

  const AttractScreen = () => (
    <div className="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 flex items-center justify-center p-8">
      <div className="text-center animate-pulse">
        <Brain className="w-48 h-48 mx-auto mb-8 text-white drop-shadow-2xl" strokeWidth={1.5} />
        <h1 className="text-8xl font-bold text-white mb-6 drop-shadow-lg">
          Medical Technology
        </h1>
        <h2 className="text-6xl font-semibold text-white mb-12 drop-shadow-lg">
          Trivia Challenge
        </h2>
        <button
          onClick={startQuiz}
          className="bg-white text-purple-600 text-5xl font-bold py-8 px-16 rounded-3xl hover:scale-110 transition-transform duration-300 shadow-2xl"
        >
          TAP TO START
        </button>
        <p className="text-3xl text-white mt-12 opacity-90">
          Test your knowledge • 23 Questions
        </p>
      </div>
    </div>
  );

  const QuizScreen = () => {
    const q = questions[currentQuestion];
    const progress = ((currentQuestion + 1) / questions.length) * 100;

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-12">
        {/* Header */}
        <div className="max-w-6xl mx-auto mb-8">
          <div className="flex justify-between items-center mb-4">
            <div className="text-white text-3xl font-semibold">
              Question {currentQuestion + 1} of {questions.length}
            </div>
            <div className="text-white text-3xl font-semibold">
              Score: {score}
            </div>
          </div>
          <div className="w-full bg-gray-700 rounded-full h-4">
            <div
              className="bg-gradient-to-r from-blue-500 to-purple-500 h-4 rounded-full transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Question */}
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-3xl p-12 mb-8 shadow-2xl">
            <h2 className="text-5xl font-bold text-gray-800 leading-tight">
              {q.question}
            </h2>
          </div>

          {/* Answers */}
          <div className="grid grid-cols-1 gap-6">
            {q.answers.map((answer, index) => {
              const isSelected = selectedAnswer === index;
              const isCorrect = index === q.correct;
              const showCorrect = showFeedback && isCorrect;
              const showIncorrect = showFeedback && isSelected && !isCorrect;

              return (
                <button
                  key={index}
                  onClick={() => handleAnswer(index)}
                  disabled={showFeedback}
                  className={`p-8 rounded-2xl text-3xl font-semibold text-left transition-all duration-300 ${
                    showCorrect
                      ? 'bg-green-500 text-white scale-105'
                      : showIncorrect
                      ? 'bg-red-500 text-white scale-95'
                      : isSelected
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-gray-800 hover:bg-blue-100 hover:scale-105'
                  } shadow-xl`}
                >
                  <div className="flex items-center justify-between">
                    <span>{answer}</span>
                    {showCorrect && <span className="text-4xl">✓</span>}
                    {showIncorrect && <span className="text-4xl">✗</span>}
                  </div>
                </button>
              );
            })}
          </div>

          {/* Next Button */}
          {showFeedback && (
            <button
              onClick={nextQuestion}
              className="mt-8 w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-4xl font-bold py-8 rounded-2xl hover:scale-105 transition-transform duration-300 shadow-2xl flex items-center justify-center gap-4"
            >
              {currentQuestion < questions.length - 1 ? 'NEXT QUESTION' : 'SEE RESULTS'}
              <ChevronRight className="w-12 h-12" />
            </button>
          )}
        </div>
      </div>
    );
  };

  const ResultsScreen = () => {
    const finalScore = score;
    const percentage = Math.round((finalScore / questions.length) * 100);
    const rank = allScores.length;

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-orange-500 p-12 flex items-center justify-center">
        <div className="max-w-5xl w-full">
          <div className="bg-white rounded-3xl p-16 shadow-2xl">
            <Trophy className="w-40 h-40 mx-auto mb-8 text-yellow-500" />
            
            <h1 className="text-7xl font-bold text-center mb-4 text-gray-800">
              Quiz Complete!
            </h1>
            
            <div className="text-center mb-12">
              <div className="text-9xl font-bold text-purple-600 mb-4">
                {finalScore}/{questions.length}
              </div>
              <div className="text-5xl text-gray-600">
                {percentage}% Correct
              </div>
            </div>

            {/* Optional Email Collection */}
            <div className="mb-8 text-center">
              <label className="text-3xl text-gray-700 mb-4 block">
                Want your results? (Optional)
              </label>
              <div className="flex gap-4 max-w-2xl mx-auto">
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Enter your email"
                  className="flex-1 px-6 py-4 text-2xl border-4 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                />
              </div>
            </div>

            {/* All Scores Leaderboard */}
            {allScores.length > 0 && (
              <div className="mb-8">
                <h3 className="text-4xl font-bold text-gray-800 mb-6 text-center">
                  Today's Scores
                </h3>
                <div className="bg-gray-100 rounded-2xl p-6 max-h-64 overflow-y-auto">
                  {allScores.slice(-10).reverse().map((s, i) => (
                    <div
                      key={i}
                      className={`flex justify-between items-center p-4 mb-2 rounded-xl ${
                        i === 0 ? 'bg-yellow-200' : 'bg-white'
                      }`}
                    >
                      <span className="text-2xl font-semibold">
                        #{allScores.length - i}
                      </span>
                      <span className="text-2xl">
                        {s.email === 'Anonymous' ? 'Anonymous' : s.email}
                      </span>
                      <span className="text-2xl font-bold text-purple-600">
                        {s.score}/{s.total}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <button
              onClick={() => {
                setScreen('attract');
                setCurrentQuestion(0);
                setScore(0);
                setSelectedAnswer(null);
                setShowFeedback(false);
                setEmail('');
              }}
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-4xl font-bold py-8 rounded-2xl hover:scale-105 transition-transform duration-300 shadow-xl flex items-center justify-center gap-4"
            >
              <RotateCcw className="w-12 h-12" />
              PLAY AGAIN
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="w-screen h-screen overflow-hidden">
      {screen === 'attract' && <AttractScreen />}
      {screen === 'quiz' && <QuizScreen />}
      {screen === 'results' && <ResultsScreen />}
    </div>
  );
};

export default MedTechQuiz;